openapi: 3.1.0
info:
  title: Forkspacer API
  version: 1.0.0
  description: API for managing workspaces and modules in Forkspacer
servers:
  - url: /api/v1
    description: API v1
paths:
  /workspace/:
    post:
      summary: Create a new workspace
      operationId: createWorkspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkspaceRequest'
      responses:
        '201':
          description: Workspace created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [created]
                              data:
                                $ref: '#/components/schemas/WorkspaceResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
    patch:
      summary: Update an existing workspace
      operationId: updateWorkspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkspaceRequest'
      responses:
        '200':
          description: Workspace updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [ok]
                              data:
                                $ref: '#/components/schemas/WorkspaceResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
    delete:
      summary: Delete a workspace
      operationId: deleteWorkspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteWorkspaceRequest'
      responses:
        '204':
          description: Workspace deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
  /workspace/list:
    get:
      summary: List workspaces
      operationId: listWorkspaces
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
            maximum: 250
            default: 25
        - name: continueToken
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of workspaces
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [ok]
                              data:
                                $ref: '#/components/schemas/ListWorkspacesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
  /workspace/connection/kubeconfig/:
    post:
      summary: Create a kubeconfig secret
      operationId: createKubeconfigSecret
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - name
                - kubeconfig
              properties:
                name:
                  type: string
                  description: DNS 1123 subdomain name
                  pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
                  maxLength: 253
                kubeconfig:
                  type: string
                  format: binary
                  description: Kubeconfig file (max 10 MB)
      responses:
        '201':
          description: Kubeconfig secret created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [created]
                              data:
                                $ref: '#/components/schemas/KubeconfigSecretResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          $ref: '#/components/responses/FormDataTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
    delete:
      summary: Delete a kubeconfig secret
      operationId: deleteKubeconfigSecret
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteKubeconfigSecretRequest'
      responses:
        '204':
          description: Kubeconfig secret deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
  /workspace/connection/kubeconfig/list:
    get:
      summary: List kubeconfig secrets
      operationId: listKubeconfigSecrets
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
            maximum: 250
            default: 25
        - name: continueToken
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of kubeconfig secrets
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [ok]
                              data:
                                $ref: '#/components/schemas/ListKubeconfigSecretsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
  /module/:
    post:
      summary: Create a new module
      operationId: createModule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateModuleRequest'
      responses:
        '201':
          description: Module created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [created]
                              data:
                                $ref: '#/components/schemas/ModuleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
    patch:
      summary: Update an existing module
      operationId: updateModule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModuleRequest'
      responses:
        '200':
          description: Module updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [ok]
                              data:
                                $ref: '#/components/schemas/ModuleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
    delete:
      summary: Delete a module
      operationId: deleteModule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteModuleRequest'
      responses:
        '204':
          description: Module deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
  /module/list:
    get:
      summary: List modules
      operationId: listModules
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
            maximum: 250
            default: 25
        - name: continueToken
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of modules
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Response'
                  - type: object
                    properties:
                      success:
                        allOf:
                          - $ref: '#/components/schemas/JSONSuccessResponse'
                          - type: object
                            properties:
                              code:
                                type: string
                                enum: [ok]
                              data:
                                $ref: '#/components/schemas/ListModulesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
components:
  schemas:
    Response:
      type: object
      properties:
        success:
          $ref: '#/components/schemas/JSONSuccessResponse'
        error:
          $ref: '#/components/schemas/JSONErrorResponse'
    JSONSuccessResponse:
      type: object
      required:
        - code
        - data
      properties:
        code:
          type: string
          enum: [ok, created, deleted]
        data: {}
    JSONErrorResponse:
      type: object
      required:
        - code
        - data
      properties:
        code:
          type: string
          enum:
            - internal_error
            - not_found
            - bad_request
            - unsupported_media_type
            - malformed_json_body
            - body_validation
            - query_validation
            - form_data_too_large
        data: {}
    WorkspaceResourceReference:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
    WorkspaceConnection:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [kubeconfig, in-cluster]
        secret:
          $ref: '#/components/schemas/WorkspaceResourceReference'
        key:
          type: string
          minLength: 1
          description: Key in the secret to retrieve. Defaults to "kubeconfig"
    WorkspaceAutoHibernation:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean
        schedule:
          type: string
          description: Cron expression (required if enabled is true)
        wakeSchedule:
          type: string
          description: Cron expression
    ManagedCluster:
      type: object
      properties:
        backend:
          type: string
          enum: [vcluster, k3d, kind]
          default: vcluster
          description: Which cluster technology to use
        distro:
          type: string
          enum: [k3s, k0s, k8s, eks]
          default: k3s
          description: Kubernetes distribution (for vcluster)
    CreateWorkspaceRequest:
      type: object
      required:
        - name
        - connection
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
        type:
          type: string
          enum: [kubernetes, managed]
          default: kubernetes
          description: Workspace type
        from:
          $ref: '#/components/schemas/WorkspaceResourceReference'
        hibernated:
          type: boolean
        connection:
          $ref: '#/components/schemas/WorkspaceConnection'
        managedCluster:
          $ref: '#/components/schemas/ManagedCluster'
        autoHibernation:
          $ref: '#/components/schemas/WorkspaceAutoHibernation'
        namespacePrefix:
          type: string
          pattern: '^[a-z0-9][-a-z0-9]*$'
          minLength: 1
          maxLength: 53
          description: Prefix for all module deployment namespaces
        createNamespace:
          type: boolean
          default: false
          description: Auto-create prefixed namespaces (requires namespacePrefix)
    UpdateWorkspaceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
        hibernated:
          type: boolean
        autoHibernation:
          $ref: '#/components/schemas/WorkspaceAutoHibernation'
        managedCluster:
          $ref: '#/components/schemas/ManagedCluster'
        namespacePrefix:
          type: string
          pattern: '^[a-z0-9][-a-z0-9]*$'
          minLength: 1
          maxLength: 53
          description: Prefix for all module deployment namespaces
        createNamespace:
          type: boolean
          description: Auto-create prefixed namespaces (requires namespacePrefix)
    DeleteWorkspaceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
    ListWorkspacesRequest:
      type: object
      properties:
        limit:
          type: integer
          format: int64
          minimum: 1
          maximum: 250
          default: 25
        continueToken:
          type: string
    WorkspaceResponse:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
        namespace:
          type: string
    WorkspaceListItem:
      type: object
      required:
        - name
        - namespace
        - phase
        - message
        - type
        - hibernated
      properties:
        name:
          type: string
        namespace:
          type: string
        phase:
          type: string
        message:
          type: string
        type:
          type: string
        hibernated:
          type: boolean
    ListWorkspacesResponse:
      type: object
      required:
        - continueToken
        - workspaces
      properties:
        continueToken:
          type: string
        workspaces:
          type: array
          items:
            $ref: '#/components/schemas/WorkspaceListItem'
    KubeconfigSecretResponse:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
        namespace:
          type: string
    DeleteKubeconfigSecretRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
    ListKubeconfigSecretsRequest:
      type: object
      properties:
        limit:
          type: integer
          format: int64
          minimum: 1
          maximum: 250
          default: 25
        continueToken:
          type: string
    ListKubeconfigSecretsResponse:
      type: object
      required:
        - continueToken
        - secrets
      properties:
        continueToken:
          type: string
        secrets:
          type: array
          items:
            $ref: '#/components/schemas/KubeconfigSecretResponse'
    WorkspaceReference:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
    ModuleSourceConfigMapRef:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
        key:
          type: string
          minLength: 1
          description: Key in the ConfigMap to retrieve
    ModuleSourceChartRepository:
      type: object
      required:
        - url
        - chart
      properties:
        url:
          type: string
          minLength: 1
          description: Helm repository URL
        chart:
          type: string
          minLength: 1
          description: Chart name
        version:
          type: string
          description: Chart version (optional)
    ModuleSourceChartGit:
      type: object
      required:
        - repo
        - path
        - revision
      properties:
        repo:
          type: string
          minLength: 1
          description: Git repository URL (https or ssh)
        path:
          type: string
          minLength: 1
          description: Path to the chart directory containing Chart.yaml
        revision:
          type: string
          minLength: 1
          default: main
          description: Git revision (branch, tag)
    ModuleSourceChartRef:
      type: object
      properties:
        configMap:
          $ref: '#/components/schemas/ModuleSourceConfigMapRef'
        repository:
          $ref: '#/components/schemas/ModuleSourceChartRepository'
        git:
          $ref: '#/components/schemas/ModuleSourceChartGit'
    ModuleSourceExistingHelmReleaseRef:
      type: object
      required:
        - name
        - namespace
        - chartSource
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: Name of the existing Helm release
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: Namespace of the existing Helm release
        chartSource:
          $ref: '#/components/schemas/ModuleSourceChartRef'
          description: Helm chart source for managing this release
        values:
          type: object
          additionalProperties: true
          description: Override values merged with existing release values
    ModuleSource:
      type: object
      properties:
        raw:
          type: string
          description: Raw YAML source
        httpURL:
          type: string
          format: uri
          description: HTTP URL to module source
        configMap:
          $ref: '#/components/schemas/ModuleSourceConfigMapRef'
          description: Reference to a ConfigMap containing module source
        existingHelmRelease:
          $ref: '#/components/schemas/ModuleSourceExistingHelmReleaseRef'
          description: Reference to an existing Helm release to manage
    CreateModuleRequest:
      type: object
      required:
        - name
        - workspace
        - source
        - config
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
        workspace:
          $ref: '#/components/schemas/WorkspaceReference'
        source:
          $ref: '#/components/schemas/ModuleSource'
        config:
          type: object
          additionalProperties: true
        hibernated:
          type: boolean
    UpdateModuleRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
        hibernated:
          type: boolean
    DeleteModuleRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$'
          maxLength: 253
          description: DNS 1123 subdomain
        namespace:
          type: string
          pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
          maxLength: 63
          description: DNS 1123 label
    ListModulesRequest:
      type: object
      properties:
        limit:
          type: integer
          format: int64
          minimum: 1
          maximum: 250
          default: 25
        continueToken:
          type: string
    ModuleResponse:
      type: object
      required:
        - name
        - namespace
      properties:
        name:
          type: string
        namespace:
          type: string
    ModuleListItem:
      type: object
      required:
        - name
        - namespace
        - phase
        - message
        - hibernated
      properties:
        name:
          type: string
        namespace:
          type: string
        phase:
          type: string
        message:
          type: string
        hibernated:
          type: boolean
    ListModulesResponse:
      type: object
      required:
        - continueToken
        - modules
      properties:
        continueToken:
          type: string
        modules:
          type: array
          items:
            $ref: '#/components/schemas/ModuleListItem'
  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Response'
              - type: object
                properties:
                  error:
                    allOf:
                      - $ref: '#/components/schemas/JSONErrorResponse'
                      - type: object
                        properties:
                          code:
                            type: string
                            enum: [bad_request, malformed_json_body, body_validation, query_validation]
    UnsupportedMediaType:
      description: Unsupported media type
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Response'
              - type: object
                properties:
                  error:
                    allOf:
                      - $ref: '#/components/schemas/JSONErrorResponse'
                      - type: object
                        properties:
                          code:
                            type: string
                            enum: [unsupported_media_type]
                          data:
                            type: string
    FormDataTooLarge:
      description: Form data too large
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Response'
              - type: object
                properties:
                  error:
                    allOf:
                      - $ref: '#/components/schemas/JSONErrorResponse'
                      - type: object
                        properties:
                          code:
                            type: string
                            enum: [form_data_too_large]
                          data:
                            type: string